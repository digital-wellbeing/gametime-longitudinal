---
title: "Simulate RICLPM with selection bias"
author: "Kristoffer"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup}
knitr::opts_knit$set(root.dir = "~/gametime-longitudinal")
library(tidyverse)
library(lavaan)
```


Let's investigate the effect of selection bias. Here I'm going to assume that there is a negative lagged effect of gaming on well-being, and see how much selection bias that would be needed to make this effect zero.

Simulate data with all cross-lagged effects set to zero. Here I've changed the simulation function allow the cross-lagged effects to differ per individual (random effects).
```{r}
source("Models/RI-CLPM/simulate-RICLPM-data.R")

params <- list(
    n = 10000,
    # beta = autoregressive params
    beta_2x = 0.66,
    beta_2y = 0.55,
    beta_3x = 0.40,
    beta_3y = 0.33,
    # gamma = cross-lagged effects
    gamma_2y = -1, # game_t1 -> well-being_t2
    gamma_2x = 0, # well-being_t1 -> game_t2
    gamma_3y = -1, # game_t2 -> well-being_t3
    gamma_3x = 0, # well-being_t2 -> game_t3
    # Random effects
    gamma_2y_sd = 0.5, # game_t1 -> well-being_t2
    gamma_2x_sd = 0.5, # well-being_t1 -> game_t2
    gamma_3y_sd = 0.5, # game_t2 -> well-being_t3
    gamma_3x_sd = 0.5, # well-being_t2 -> game_t3
    x_mean = 2,
    y_mean = 4,
    ## covariances
    sd_wx1 = 1,
    sd_wy1 = 1,
    cor_wx1_wy1 = 0.5,
    sd_wx2 = 1.33,
    sd_wy2 = 1.33,
    cor_wx2_wy2 = 0.6,
    sd_wx3 = 1.33,
    sd_wy3 = 1.33,
    cor_wx3_wy3 = 0.44,
    sd_x_RE = 1.2,
    sd_y_RE = 1.2,
    cor_xy_intercepts = 0.33,
    keep_cross_effects = TRUE
    )

set.seed(1338)
d <- do.call(sim_RICLPM_data, params)
```


```{r}
colMeans(d)
apply(d, 2, sd)
```

# lavaan RICLPM
```{r echo=FALSE}
# Based on: https://jeroendmulder.github.io/RI-CLPM/lavaan.html
riclpm <- '
  # Create between components (random intercepts)
  RIx =~ 1*x1 + 1*x2 + 1*x3
  RIy =~ 1*y1 + 1*y2 + 1*y3

  # Create within-person centered variables
  wx1 =~ 1*x1
  wx2 =~ 1*x2
  wx3 =~ 1*x3
  wy1 =~ 1*y1
  wy2 =~ 1*y2
  wy3 =~ 1*y3

  # Estimate the lagged effects between the within-person centered variables.
  wx2 + wy2 ~ wx1 + wy1
  wx3 + wy3 ~ wx2 + wy2

  # Estimate the covariance between the within-person centered
  # variables at the first wave.
  wx1 ~~ wy1 # Covariance

  # Estimate the covariances between the residuals of the
  # within-person centered variables (the innovations).
  wx2 ~~ wy2
  wx3 ~~ wy3

  # Estimate the variance and covariance of the random intercepts.
  RIx ~~ RIx
  RIy ~~ RIy
  RIx ~~ RIy

  # Estimate the (residual) variance of the within-person centered variables.
  wx1 ~~ wx1 # Variances
  wy1 ~~ wy1
  wx2 ~~ wx2 # Residual variances
  wy2 ~~ wy2
  wx3 ~~ wx3
  wy3 ~~ wy3
'
fit_RICLPM <- lavaan(
    riclpm, 
    data = d, 
    meanstructure = TRUE, 
    int.ov.free = TRUE
) 
```

```{r, echo =FALSE}
coefs <- coef(fit_RICLPM)
res <- data.frame(
    term = names(coefs),
    est = coefs,
    theta = with(
        params,
            c(
                beta_2x,
                gamma_2x,
                gamma_2y,
                beta_2y,
                beta_3x,
                gamma_3x,
                gamma_3y,
                beta_3y,
                sd_wx1 * sd_wy1 * cor_wx1_wy1,
                sd_wx2 * sd_wy2 * cor_wx2_wy2,
                sd_wx3 * sd_wy3 * cor_wx3_wy3,
                sd_x_RE^2,
                sd_y_RE^2,
                sd_x_RE * sd_y_RE * cor_xy_intercepts,
                sd_wx1^2,
                sd_wy1^2,
                sd_wx2^2,
                sd_wy2^2,
                sd_wx3^2,
                sd_wy3^2,
                rep(NA, 6) # ignore means
            )
    ),
    row.names = NULL
)


res %>%
    filter(term %in% c("wx2~wy1", "wx3~wy2", "wy2~wx1", "wy3~wx2")) %>%
ggplot(aes(y = factor(term, levels = c(names(coefs))))) + 
    geom_point(aes(x = est, color = "est")) +
    geom_point(aes(x = theta, color = "theta"), 
    position = position_nudge(y = 0.1)) +
    labs(
        y = "Terms",
        x = "Value",
        title = "RI-CLPM fit to RI-CLPM data with random cross-lagged effects",
        subtitle = "Only cross-lagged effects"
    ) 
```

Estimates are correct.


## Add selection Bias
In the whole population there is on average a negative effect of time spent gaming on well-being. For simplicity, I'm just selecting directly on the $\text{game time}_{t - i} \rightarrow \text{well-being}_t$ effect here. So that individuals where the effect is weaker or positive are more likely to join the study. Any indirect selection process would probably be weaker.

I've set the response rate to 3%, and use a logistic function to convert $\text{game time}_{t - i} \rightarrow \text{well-being}_t$ into individual probabilities of joining the study.

```{r}
# marginal response rate
resp_rate <- 0.03

# OR for likelihood of joining the study for every 1 increase
# in cross-lagged game -> well-being effect
log_OR <- log(100)

# this is bascially a GLMM, so approximate the marginal intercept
# to make the marginal response rate be the same for different OR values
C <- (16 * sqrt(3)) / (15 * pi)
intercept <- qlogis(resp_rate) * sqrt(C^2 * var(d$gamma_2y * log_OR) + 1)
d$p <- plogis(intercept + (d$gamma_2y - mean(d$gamma_2y)) * log_OR)
d$included <- rbinom(nrow(d), 1, d$p)

ggplot(filter(d, included == 0), 
        aes(gamma_2y, p, color = factor(included))
    ) + 
    geom_point(
        position = position_jitter(width = 0, height = 0.1), 
        alpha = 1
        ) +
    geom_point(
        data = filter(d, included == 1),
        position = position_jitter(width = 0, height = 0.1), 
        alpha = 0.5
        ) +
    geom_vline(xintercept = 0) +
        scale_color_manual(values = c("gray50", "#a70808")) +
        labs(
            x = "Effect game[t1] -> well-being[t2]", 
            y = "p(Joining study)"
        )


ggplot(d, aes(gamma_2y, y2, color=factor(included))) + 
    geom_point() + 
    scale_color_manual(values = c("gray50", "#a70808")) +
    labs(x = "Effect game[t1] -> well-being[t2]", y = "well-being[t2]")



```

```{r}
d_selection <- filter(d, included == 1)

## response rate
nrow(d_selection) / nrow(d) 

## refit to subset of responders
fit_RICLPM <- lavaan(
    riclpm, 
    data = d_selection, 
    meanstructure = TRUE, 
    int.ov.free = TRUE
) 
```



```{r, echo =FALSE}
coefs <- coef(fit_RICLPM)
res <- data.frame(
    term = names(coefs),
    est = coefs,
    theta = with(
        params,
            c(
                beta_2x,
                gamma_2x,
                gamma_2y,
                beta_2y,
                beta_3x,
                gamma_3x,
                gamma_3y,
                beta_3y,
                sd_wx1 * sd_wy1 * cor_wx1_wy1,
                sd_wx2 * sd_wy2 * cor_wx2_wy2,
                sd_wx3 * sd_wy3 * cor_wx3_wy3,
                sd_x_RE^2,
                sd_y_RE^2,
                sd_x_RE * sd_y_RE * cor_xy_intercepts,
                sd_wx1^2,
                sd_wy1^2,
                sd_wx2^2,
                sd_wy2^2,
                sd_wx3^2,
                sd_wy3^2,
                rep(NA, 6) # ignore means
            )
    ),
    row.names = NULL
)


res %>%
    filter(term %in% c("wx2~wy1", "wx3~wy2", "wy2~wx1", "wy3~wx2")) %>%
ggplot(aes(y = factor(term, levels = c(names(coefs))))) + 
    geom_point(aes(x = est, color = "est")) +
    geom_point(aes(x = theta, color = "theta"), 
    position = position_nudge(y = 0.1)) +
    labs(
        y = "Terms",
        x = "Value",
        title = "RI-CLPM fit to RI-CLPM data with selection bias",
        subtitle = "Only cross-lagged effects"
    ) 
```
```

- Clearly this selection add bias the cross-lagged effects.
- Current paramater values make little sense. 
- Can we use a similar simulation to for a sensitivity analysis?