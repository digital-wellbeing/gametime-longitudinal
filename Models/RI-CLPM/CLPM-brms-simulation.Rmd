---
title: "brms CLPM vs lavaan CLPM"
author: "Kristoffer"
date: "`r Sys.Date()`"
output: html_document
---

Let's try to fit the CLPM data using brms in either wide or long format.

```{r setup}
knitr::opts_knit$set(root.dir = "~/gametime-longitudinal")
options(mc.cores = 4)
options(brms.backend = "cmdstanr")


## helper
#' Compare regression coefs from brms and lavaan model
compare_models <- function(fit_brms, fit_lavaan, constrained = FALSE) {
    if(constrained) {
        index_brms <- 3:6
        index_lavaan <- c("d", "c", "a", "b")
    } else {
        index_brms <- 5:12
        index_lavaan <- 1:8
    }
    coefs_brms <- fixef(fit_brms)[index_brms, ]
    coefs_lavaan <- coef(fit_lavaan)[index_lavaan]

    data.frame(
        brms_terms = rownames(coefs_brms), 
        lavaan_terms = names(coefs_lavaan),
        brms_estimate = coefs_brms[, "Estimate"],
        lavaan_estimate = coefs_lavaan,
        row.names = NULL
    ) %>%
    knitr::kable(digits = 2)
}
```

```{r}
library(brms)
library(lavaan)
library(tidyverse)
```

```{r}
source("Models/RI-CLPM/simulate-RICLPM-data.R")
# CLPM becase random intercepts = 0
set.seed(1337)
params <- list(
    n = 5000,
    # beta = autoregressive params
    beta_2x = 0.66,
    beta_2y = 0.55,
    beta_3x = 0.40,
    beta_3y = 0.33,
    # gamma = cross-lagged effects
    gamma_2x = 0.22,
    gamma_2y = 0.33,
    gamma_3x = 0.44,
    gamma_3y = 0.55,
    x_mean = 2,
    y_mean = 4,
    ## covariances
    sd_wx1 = 1,
    sd_wy1 = 1,
    cor_wx1_wy1 = 0.5,
    sd_wx2 = 1.7,
    sd_wy2 = 1.33,
    cor_wx2_wy2 = 0.6,
    sd_wx3 = 1.33,
    sd_wy3 = 1.44,
    cor_wx3_wy3 = 0.44,
    sd_x_RE = 0,
    sd_y_RE = 0,
    cor_xy_intercepts = 0
)
d <- do.call(sim_RICLPM_data, params)
d$id <- 1:nrow(d)
```

```{r}
# Based on: https://jeroendmulder.github.io/RI-CLPM/lavaan.html
CLPM <- '
  # Estimate the lagged effects between the observed variables.
  x2 + y2 ~ x1 + y1
  x3 + y3 ~ x2 + y2

  # Estimate the covariance between the observed variables at the first wave. 
  x1 ~~ y1 # Covariance
  
  # Estimate the covariances between the residuals of the observed variables.
  x2 ~~ y2
  x3 ~~ y3
  
  # Estimate the (residual) variance of the observed variables.
  x1 ~~ x1 # Variances
  y1 ~~ y1 
  x2 ~~ x2 # Residual variances
  y2 ~~ y2 
  x3 ~~ x3 
  y3 ~~ y3 
'
fit_CLPM <- lavaan(CLPM, data = d, meanstructure = TRUE, int.ov.free = TRUE) 
summary(fit_CLPM, standardized = FALSE)
```

Let's just ignore the co-variance structure for now. This should fit the same regression model as lavaan.
```{r}
fx2 <- bf(x2 ~ x1 + y1)
fy2 <- bf(y2 ~ x1 + y1)
fx3 <- bf(x3 ~ x2 + y2)
fy3 <- bf(y3 ~ x2 + y2)

fit_brms_wide <- brm(
    formula =
        fx2 + fy2 +
        fx3 + fy3 +
        set_rescor(FALSE),
    data = d,
    file = "Models/RI-CLPM/fits/CLPM-brms-wide",
)
compare_models(fit_brms_wide, fit_CLPM)
```

Coefs are identical.

## Long format?
Can we get similar answers from a model in long format? I guess results should be similar to constrained CLPM in lavaan?
```{r}
# Based on: https://jeroendmulder.github.io/RI-CLPM/lavaan.html
CLPM_constrained <- '
  # Estimate the (constrained) lagged effects between the observed variables.
  x2 ~ a*x1 + b*y1 
  y2 ~ c*x1 + d*y1
  x3 ~ a*x2 + b*y2
  y3 ~ c*x2 + d*y2

  # Estimate the covariance between the observed variables at the first wave. 
  x1 ~~ y1 # Covariance
  
  # Estimate the covariances between the residuals of the observed variables.
  x2 ~~ y2
  x3 ~~ y3
  
  # Estimate the (residual) variance of the observed variables.
  x1 ~~ x1 # Variances
  y1 ~~ y1 
  x2 ~~ x2 # Residual variances
  y2 ~~ y2 
  x3 ~~ x3 
  y3 ~~ y3 
'
fit_CLPM_constrained <- lavaan(CLPM_constrained, data = d) 
summary(fit_CLPM_constrained, standardized = FALSE)
```


```{r}
d_long <- pivot_longer(
    d,
    -id,
    names_to = c(".value", "time"),
    names_pattern = c("(.)(.)")
)
d_long <- 
    d_long %>% 
    group_by(id) %>%
    mutate(
        x_lag = lag(x),
        y_lag = lag(y),
        w_mean_x = mean(x),
        w_mean_y = mean(y),
        wx = x - w_mean_x,
        wy = y - w_mean_y,
        wx_lag = lag(wx),
        wy_lag = lag(wy)
    ) %>%
    ungroup
head(d_long)
```

Uncentered
```{r}
fy <- bf(y ~ y_lag + x_lag)
fx <- bf(x ~ x_lag + y_lag)
fit_brms_long <- brm(
    fy + fx + set_rescor(FALSE),
    data = d_long,
    file = "Models/RI-CLPM/fits/CLPM-brms-long"
)
compare_models(fit_brms_long, fit_CLPM_constrained, constrained = TRUE)
```

```{r}
fy <- bf(y ~ y_lag + x_lag + (1 | c | id))
fx <- bf(x ~ x_lag + y_lag + (1 | c | id))
fit_brms_long_RE <- brm(
    fy + fx + set_rescor(FALSE),
    data = d_long,
    file = "Models/RI-CLPM/fits/CLPM-brms-long-RE"
)
compare_models(fit_brms_long_RE, fit_CLPM_constrained, constrained = TRUE)
```

Centered
```{r}
fy <- bf(wy ~ wy_lag + wx_lag)
fx <- bf(wx ~ wx_lag + wy_lag)
fit_brms_long_centered <- brm(
    fy + fx + set_rescor(FALSE),
    data = d_long,
    file = "Models/RI-CLPM/fits/CLPM-brms-long-centered"
)
compare_models(fit_brms_long_centered, fit_CLPM_constrained, constrained = TRUE)
```

I'd say that the uncentered cross-lagged model (`fit_brms_long`), without any random effects, is close enough?