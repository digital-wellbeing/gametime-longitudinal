---
title: "Descriptive"
author:
  - name: <a href="https://vuorre.netlify.app">Matti Vuorre</a>
    affiliation: <a href="https://www.oii.ox.ac.uk/people/matti-vuorre/">University of Oxford</a>
  - name: Your Name Here
    affiliation: University
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    theme: yeti
    highlight: kate
    self_contained: true
    number_sections: false
    toc: true
    toc_depth: 2
    toc_float:
      collapsed: false
      smooth_scroll: false
---

```{r packages, include = FALSE}
library(knitr)
library(scales)
library(janitor)
library(ggbeeswarm)
library(gtsummary)
library(bayestestR)
library(brms)
library(tidybayes)
library(broom)
library(here)
library(lubridate)
library(naniar)
library(ggtext)
library(emmeans)
library(ggstance)
library(ggdist)
library(patchwork)
library(readxl)
library(lavaan)
library(GGally)
# remotes::install_github("jflournoy/riclpmr")  
library(riclpmr)
library(ggnewscale)
library(showtext)
library(tidyverse)
```

```{r setup, include=FALSE}
# Knitr options
opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  cache = TRUE,
  error = FALSE,
  message = FALSE,
  fig.align = "center",
  fig.retina = 2
)
```


```{r}
data_path <- here("Data", "cleaned_data.Rds")
if(file.exists(data_path)) {
d <- readRDS(file = data_path)
} else {
    stop("'Data/cleaned_data.Rds' doesn't exist, run `Analysis/data_cleaning.Rmd` to create it.")
}
```

# Demographics

Before exclusions

```{r}
theme_gtsummary_compact()
d %>%
  distinct(pid, Game, Age, Experience, Gender) %>%
  select(-pid) %>%
  tbl_summary(by = Game, missing_text = "Missing") %>%
  add_overall() %>% 
  bold_labels() %>% 
  italicize_levels()  
```

# Survey descriptives

## Response rate & retention

We calculate response rates and retention with the above assumptions (e.g. a "participant" is someone who answered at least one survey item).

```{r}
# Get data on invite dates and Ns
invites <- read_excel(here("Data", "invites.xlsx"))
# Create a table where wave 0 are number of invites,
# then calculate response rate / retention at each wave.
# This assumes there are no new participants at wave 3
# (people who didn't participate in wave 2 showed up at wave 3).
bind_rows(select(invites, -date), count(d, Game, wid)) %>%
  arrange(Game, wid) %>%
  group_by(Game) %>%
  mutate(
    R_rate = percent(n / lag(n), .1),
    n = comma(n)
  ) %>%
  pivot_wider(names_from = wid, values_from = c(n, R_rate)) %>%
  mutate(
    Invites = n_0,
    `Wave 1` = str_glue("{n_1} ({R_rate_1})"),
    `Wave 2` = str_glue("{n_2} ({R_rate_2})"),
    `Wave 3` = str_glue("{n_3} ({R_rate_3})")
  ) %>%
  select(Game, Invites:`Wave 3`) %>%
  mutate(across(everything(), ~ str_replace(., "NA", "0"))) %>%
  kable(caption = "Number of people (response/retention rate) participating at each wave.")
```

How many participants completed N waves

```{r}
d %>%
  count(Game, pid, name = "Waves") %>%
  tabyl(Game, Waves) %>%
  as_tibble() %>%
  rowwise() %>%
  mutate(Total = sum(`1`, `2`, `3`)) %>%
  ungroup() %>%
  mutate(across(`1`:`3`, .fns = list(p = function(x) percent(x / Total, .1)))) %>%
  mutate(
    `1 wave` = str_glue("{`1`} ({`1_p`})"),
    `2 waves` = str_glue("{`2`} ({`2_p`})"),
    `3 waves` = str_glue("{`3`} ({`3_p`})")
  ) %>%
  select(Game, Total, `1 wave`:`3 waves`) %>%
  kable(caption = "Number of people (percentage) completing 1/2/3 waves per company.")
d %>%
  count(pid, name = "Waves") %>%
  tabyl(Waves) %>%
  adorn_pct_formatting() %>%
  as_tibble() %>%
  kable(caption = "Number of people (percentage) completing 1/2/3 waves total.")
```

## Response dates

```{r}
d %>%
  mutate(Date = as_date(StartDate)) %>%
  count(Game, Wave, Date) %>%
  ggplot(
    aes(Date, n, fill = Wave)
  ) +
  geom_col() +
  scale_y_continuous(
    "Responses",
    breaks = pretty_breaks(10),
    expand = expansion(c(0, .1)),
  ) +
  scale_x_date(
    "Date",
    date_breaks = "7 day", date_labels = "%b %d", date_minor_breaks = "1 day"
  ) +
  # geom_text(aes(label = n), nudge_y = 10) +
  facet_wrap("Game", scales = "free_y", ncol = 2)
```

Response times in BST

```{r}
d %>%
  mutate(Hour = hour(StartDate)) %>%
  count(Game, Wave, Hour) %>%
  ggplot(aes(Hour, y = n, fill = Wave)) +
  scale_y_continuous(
    "Responses",
    breaks = pretty_breaks(10),
    expand = expansion(c(0, .1)),
  ) +
  scale_x_continuous(
    breaks = seq(0, 21, by = 3),
    expand = expansion(c(0.01)),
    labels = function(x) paste0(x, ":00")
  ) +
  geom_col() +
  facet_wrap("Game", scales = "free", ncol = 2)
```

### Durations between waves

Participants could respond with variable delays due to variation in email schedules and late responding. So we also check the actual intervals between completing waves

```{r}
d %>%
  select(wid, Game, Interval) %>%
  group_by(Game, wid) %>%
  filter(wid > 1) %>%
  summarise(
    min = min(Interval, na.rm = TRUE) %>% round(1),
    q25 = quantile(Interval, .25, na.rm = TRUE) %>% round(1),
    median = median(Interval, na.rm = TRUE) %>% round(1),
    q75 = quantile(Interval, .75, na.rm = TRUE) %>% round(1),
    max = max(Interval, na.rm = TRUE) %>% round(1),
    n = n()
  ) %>%
  kable(caption = "Interval durations preceding waves 2 and 3.")
d %>%
  filter(Wave != "Wave 1") %>%
  mutate(Wave = fct_drop(Wave)) %>%
  ggplot(aes(Interval)) +
  geom_vline(xintercept = 14, size = .2) +
  geom_histogram(binwidth = 1, col = "white") +
  scale_y_continuous(
    "Count",
    expand = expansion(c(0, .1))
  ) +
  scale_x_continuous(
    "Days between responding",
    breaks = seq(0, 28, by = 7)
  ) +
  facet_grid(Game ~ Wave, scales = "free_y")
```

## How many people had telemetry

For at least one wave

```{r}
d %>%
  mutate(has_telemetry = !is.na(Hours)) %>%
  group_by(Game, pid) %>%
  summarise(`Has telemetry` = any(has_telemetry)) %>%
  select(-pid) %>%
  tbl_summary(by = Game)
```

## Exclusions

As in our previous study we exclude observations more extreme than 6SD

```{r}
d <- d %>%
  pivot_longer(c(Hours, hours_est:Extrinsic)) %>%
  group_by(Game, name) %>%
  mutate(z = as.numeric(scale(value)))
```

```{r}
# This is what are taken out
d %>%
  summarise(
    Extremes = sum(abs(z >= 6), na.rm = TRUE),
    Extremes_p = percent(Extremes / n(), accuracy = .01)
  ) %>%
  filter(Extremes > 0)
d %>%
  group_by(name) %>%
  summarise(
    Extremes = sum(abs(z >= 6), na.rm = TRUE),
    Extremes_p = percent(Extremes / n(), accuracy = .01)
  ) %>%
  filter(Extremes > 0)
```

```{r}
d <- d %>%
  mutate(value = ifelse(abs(z >= 6), NA, value)) %>%
  select(-z) %>%
  pivot_wider(names_from = "name", values_from = "value") %>%
  ungroup()
```
